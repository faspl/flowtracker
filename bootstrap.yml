---

- name: Boostrap
  hosts: all_switches
  connection: local
  gather_facts: no

  tasks:
    - name: shutdown interconnects
      nxos_interface:
        interface: "{{ item }}"
        admin_state: down
        host: "{{ inventory_hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"
      with_items: "{{ down_interfaces }}"

    - name: Loopbacks Up
      nxos_interface:
        interface: "{{ loopback_int }}"
        admin_state: up
        host: "{{ inventory_hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"

    - name: Loopback IP address
      nxos_ipv4_interface:
        interface: "{{ loopback_int }}"
        ip_addr: "{{ loop_ip }}"
        mask: 32
        host: "{{ inventory_hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"

    - name: Interfaces Up and Routed
      nxos_interface:
        interface: "{{ item }}"
        admin_state: up
        mode: layer3
        host: "{{ inventory_hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"
      with_items: "{{ interfaces }}"

    - name: Interface IP addresses
      nxos_ipv4_interface:
        interface: "{{ item.interface }}"
        ip_addr: "{{ item.ip }}"
        mask: 24
        host: "{{ inventory_hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"
      with_items: "{{ interfaces_ips }}"

    - name: Turn on OSPF
      nxos_feature:
        feature: ospf
        state: enabled
        host: "{{ inventory_hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"

    - name: Router OSPF
      nxos_command:
        command: router ospf {{ instance_tag }} ; router-id {{ loop_ip }}
        type: config
        host: "{{ inventory_hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"

    - name: OSPF - LoopBack Interfaces
      nxos_command:
        command: interface {{ loopback_int }} ; ip router ospf {{ instance_tag }} area {{ area }}
        type: config
        host: "{{ inventory_hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"

    - name: OSPF - Ethernet Interfaces
      nxos_command:
        command: interface {{ item }} ; ip router ospf {{ instance_tag }} area {{ area }}
        type: config
        host: "{{ inventory_hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"
      with_items: "{{ interfaces }}"
